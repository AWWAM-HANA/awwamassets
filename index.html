<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Senarai Aset</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
    }
    tfoot th {
      text-align: right;
    }
    select {
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Senarai Aset</h1>
  <table id="assetTable" class="display nowrap" style="width:100%">
    <thead></thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th></th> <!-- Asset -->
        <th></th> <!-- Jenis Aset -->
        <th></th> <!-- Tahun -->
        <th></th> <!-- Item -->
        <th></th> <!-- Detail -->
        <th></th> <!-- NETT PRICE -->
        <th></th> <!-- GST -->
        <th></th> <!-- TOTAL -->
      </tr>
    </tfoot>
  </table>

  <!-- jQuery + DataTables + PapaParse -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    // Load CSV
    Papa.parse("aset.csv", {
      download: true,
      header: true,
      complete: function(results) {
        let data = results.data.filter(row => Object.values(row).some(val => val.trim() !== ""));
        let headers = Object.keys(data[0]);

        // Build header
        let thead = "<tr>";
        headers.forEach(h => { thead += "<th>" + h + "</th>"; });
        thead += "</tr>";
        document.querySelector("#assetTable thead").innerHTML = thead;

        // Build rows
        let rows = "";
        data.forEach(row => {
          rows += "<tr>";
          headers.forEach(h => { 
            if(h === "NETT PRICE" || h === "GST" || h === "TOTAL") {
              let val = parseFloat(row[h].replace(/,/g,'')) || 0;
              rows += "<td>" + new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val) + "</td>";
            } else {
              rows += "<td>" + (row[h] || "") + "</td>";
            }
          });
          rows += "</tr>";
        });
        document.querySelector("#assetTable tbody").innerHTML = rows;

        // Init DataTable
        let table = $('#assetTable').DataTable({
          dom: 'Bfrtip',
          buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
          pageLength: 10,
          scrollX: true,
          fixedHeader: true,
          footerCallback: function(row, data, start, end, display) {
            let api = this.api();
            let parseValue = function(i) {
              return typeof i === 'string' ? parseFloat(i.replace(/[^0-9.-]+/g,"")) || 0 : typeof i === 'number' ? i : 0;
            };
            let formatRM = new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format;

            let nettTotal = api.column(5, { page: 'current' }).data().reduce((a,b)=>parseValue(a)+parseValue(b),0);
            let gstTotal = api.column(6, { page: 'current' }).data().reduce((a,b)=>parseValue(a)+parseValue(b),0);
            let totalTotal = api.column(7, { page: 'current' }).data().reduce((a,b)=>parseValue(a)+parseValue(b),0);

            $(api.column(5).footer()).html(formatRM(nettTotal));
            $(api.column(6).footer()).html(formatRM(gstTotal));
            $(api.column(7).footer()).html(formatRM(totalTotal));
          }
        });

        // Global search placeholder
        $('#assetTable_filter input').attr('placeholder', 'Cari aset...');

        // Dropdown filter ikut Jenis Aset (contoh: column 1 = Jenis Aset)
        table.columns([1,2]).every(function() {
          let column = this;
          let select = $('<select><option value="">All</option></select>')
            .appendTo($(column.header()).empty())
            .on('change', function() {
              let val = $.fn.dataTable.util.escapeRegex($(this).val());
              column.search(val ? '^'+val+'$' : '', true, false).draw();
            });
          column.data().unique().sort().each(function(d){ if(d) select.append('<option value="'+d+'">'+d+'</option>'); });
        });
      }
    });
  </script>
</body>
</html>
