<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Senarai Aset</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<style>
  body { font-family: Arial, sans-serif; margin:20px; background:#f9f9f9; }
  h1 { text-align:center; color:#333; }
  h3 { text-align:center; color:#555; margin-top:0; font-weight:normal; }
  table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.05); border-radius:8px; overflow:hidden; }
  th { background:#00aaff; color:#000; padding:8px 12px; text-align:left; }
  td { padding:8px 12px; border:1px solid #ddd; }
  tfoot th { background:#f1f1f1; font-weight:bold; text-align:right; }
  tr:nth-child(even){ background:#f9f9f9; }
  tr:hover{ background:#ffeeba; }
  select{ width:100%; }

  /* If you want to keep numeric buttons hidden, leave this rule.
     Remove it if you want Prev/Next & page numbers visible. */
  .dataTables_paginate .paginate_button { display: none; }

  /* Make the page-length dropdown compact and inline */
  .dataTables_length select { width:auto; }
</style>
</head>
<body>

<h1>Senarai Aset Syarikat</h1>
<h3>Data terkini sehingga September 2025</h3>

<table id="assetTable" class="display nowrap" style="width:100%">
  <thead></thead>
  <tfoot>
    <tr>
      <th></th><th></th><th></th><th></th><th></th>
      <th></th><th></th><th></th><th></th><th></th><th></th>
    </tr>
  </tfoot>
  <tbody></tbody>
</table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
  // Helper: safe currency format
  const formatMYR = (v) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(v || 0);

  Papa.parse("aset.csv", {
    download: true,
    header: true,
    complete: function(results) {
      // Filter out empty rows robustly
      const data = (results.data || []).filter(row =>
        Object.values(row || {}).some(val => (val ?? "").toString().trim() !== "")
      );

      // Handle empty CSV gracefully
      if (!data.length) {
        document.querySelector("#assetTable thead").innerHTML =
          "<tr><th>Tiada data</th></tr>";
        document.querySelector("#assetTable tbody").innerHTML =
          "<tr><td>Fail CSV kosong atau tiada baris sah.</td></tr>";
        return;
      }

      const headers = Object.keys(data[0] || {});
      const moneyCols = new Set(["NETT PRICE","GST","TOTAL","DEPR","ACC DEPR","NBV"]);

      // Build table header
      let thead = "<tr>";
      headers.forEach(h => { thead += "<th>" + h + "</th>"; });
      thead += "</tr>";
      document.querySelector("#assetTable thead").innerHTML = thead;

      // Build table body
      let rows = "";
      data.forEach(row => {
        rows += "<tr>";
        headers.forEach(h => {
          const raw = row[h] ?? "";
          if (moneyCols.has(h)) {
            const num = parseFloat(String(raw).replace(/,/g,'')) || 0;
            rows += "<td>" + formatMYR(num) + "</td>";
          } else {
            rows += "<td>" + raw + "</td>";
          }
        });
        rows += "</tr>";
      });
      document.querySelector("#assetTable tbody").innerHTML = rows;

      // Initialize DataTable
      const table = $('#assetTable').DataTable({
        // Add 'l' (length menu) so user can choose items per page
        // Layout: length (l), Buttons (B), filter (f), table (rt), info (i), paging (p)
        dom: 'lBfrtip',
        buttons: ['copy','csv','excel','pdf','print'],
        scrollX: true,
        fixedHeader: true,

        // Default and options for "items per page", include "All" (-1)
        pageLength: 100,
        lengthMenu: [[50,100,500,1000,-1], [50,100,500,1000,'All']],

        paging: true,
        stateSave: true, // remember selection across reloads

        // Correct info line & better labels
        language: {
          lengthMenu: 'Show _MENU_ per page',
          info: 'Showing _START_ to _END_ of _TOTAL_ entries',
          infoEmpty: 'Showing 0 to 0 of 0 entries',
          infoFiltered: '(filtered from _MAX_ total entries)',
          search: 'Search:'
        },

        footerCallback: function(row, data, start, end, display) {
          const api = this.api();
          const parseValue = (i) => {
            if (typeof i === 'string') return parseFloat(i.replace(/[^0-9.-]+/g,'')) || 0;
            if (typeof i === 'number') return i;
            return 0;
          };

          // Adjust these column indexes if your money columns are elsewhere
          const cols = [5,6,7,8,9,10];

          cols.forEach(idx => {
            if (idx >= headers.length) return; // guard if fewer columns
            const sum = api.column(idx, { page: 'current' }).data()
              .reduce((a, b) => parseValue(a) + parseValue(b), 0);
            $(api.column(idx).footer()).html(formatMYR(sum));
          });

          api.columns.adjust();
        }
      });

      // Global search placeholder
      $('#assetTable_filter input').attr('placeholder','Cari aset...');

      // Dropdown filter for Asset Name (assumed column 0) â€” keep as in your version
      table.columns([0]).every(function(){
        const column = this;
        const $header = $(column.header());
        const select = $('<select><option value="">All</option></select>')
          .appendTo($header.empty())
          .on('change', function() {
            const val = $.fn.dataTable.util.escapeRegex($(this).val() || '');
            column.search(val ? '^' + val + '$' : '', true, false).draw();
            table.columns.adjust();
          });

        column.data().unique().sort().each(d => {
          if (d) select.append('<option value="' + d + '">' + d + '</option>');
        });
      });

      table.columns.adjust();
    }
  });
</script>
</body>
</html>
